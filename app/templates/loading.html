{% macro loading_animation() %}
<style>
  body {
    margin: 0;
  }

  #loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 1;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    display: flex; /* set parent to flex */
    justify-content: center; /* horizontally center children */
    align-items: center; /* vertically center children */
    transition: opacity 0.5s ease-out; /* 0.5s fade out */
  }

  #vinyl {
    width: 250px;
    height: 250px;
    background-repeat: no-repeat;
    background-size: cover;
    animation: spin 1.5s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>

<div id="loading-overlay">
  <div id="vinyl"></div>
</div>

<script>
  let timeoutId;

  const vinyls = [
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader1',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader10',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader11',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader14',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader15',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader16',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader17',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader19',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader20',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader21',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader22',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader23',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader24',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader26',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader27',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader28',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader29',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader3',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader31',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader33',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader34',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader36',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader37',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader38',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader4',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader40',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader41',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader42',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader44',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader45',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader46',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader47',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader48',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader5',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader50',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader51',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader52',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader54',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader56',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader58',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader6',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader60',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader61',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader7',
    'https://res.cloudinary.com/dn9bcrimg/image/upload/v1/discloader/Loader8',
  ];

  function getRandomVinyl() {
    const randomIndex = Math.floor(Math.random() * vinyls.length);
    return vinyls[randomIndex];
  }

  window.showLoading = function (duration = 4000) {
    let loadingOverlay = document.getElementById('loading-overlay');
    let vinylElement = document.getElementById('vinyl');

    // If the loadingOverlay is already displayed, don't do anything
    if (loadingOverlay && loadingOverlay.style.display === 'flex') {
      return;
    }

    // If the loading animation elements don't exist, create them
    if (!loadingOverlay) {
      loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'loading-overlay';
      document.body.appendChild(loadingOverlay);
    }

    if (!vinylElement) {
      vinylElement = document.createElement('div');
      vinylElement.id = 'vinyl';
      loadingOverlay.appendChild(vinylElement);
    }

    // Continue as before
    vinylElement.style.backgroundImage = `url(${getRandomVinyl()})`;
    loadingOverlay.style.display = 'flex';
    timeoutId = setTimeout(window.hideLoading, duration); // Use the passed duration
  };

  let animationDisplayedAt = new Date().getTime();

  window.hideLoading = function () {
    clearTimeout(timeoutId);
    const loadingOverlay = document.getElementById('loading-overlay');
    const fadeOutDuration = 500;

    const completeHide = () => {
      // Instead of hiding, remove the element entirely
      loadingOverlay.remove();
    };

    const timeSinceAnimationDisplayed =
      new Date().getTime() - animationDisplayedAt;
    const minimumDisplayTime = 1000;

    if (timeSinceAnimationDisplayed < minimumDisplayTime) {
      setTimeout(() => {
        loadingOverlay.style.opacity = '0';
        setTimeout(completeHide, fadeOutDuration);
      }, minimumDisplayTime - timeSinceAnimationDisplayed);
    } else {
      loadingOverlay.style.opacity = '0';
      setTimeout(completeHide, fadeOutDuration);
    }
  };

  window.showLoading();

  window.addEventListener('load', function () {
    window.hideLoading();
  });

  let ajaxRequestCount = 0;

  $(document).ajaxStart(function () {
    ajaxRequestCount++;
    if (ajaxRequestCount === 1 && !window.isArtGenerationRequest) {
      window.showLoading();
    }
  });

  $(document).ajaxStop(function () {
    ajaxRequestCount--;
    if (ajaxRequestCount === 0 && !window.isArtGenerationRequest) {
      window.hideLoading();
    }
  });

  $(document).on('submit', 'form', function (event) {
    var useAjax = $(this).data('ajax');

    if (useAjax) {
      event.preventDefault();

      window.showLoading();

      $.ajax({
        url: $(this).attr('action'),
        method: $(this).attr('method'),
        data: $(this).serialize(),
        complete: function () {
          window.hideLoading();
        },
      });
    } else {
      window.showLoading();
    }
  });
</script>
{% endmacro %}
