const config={loaderSelector:"#loading-overlay",featureEnabledKeywords:["profile","recommendations","playlist"],};const LONG_REQUEST_THRESHOLD=30000;const loader=document.querySelector(config.loaderSelector);let activeRequests=0;let longRunningRequests=new Set();window.showLoading=function(duration=4000){if(loader&&loader.style.display!=="flex"){loader.style.display="flex";if(duration!==Infinity){setTimeout(window.hideLoading,duration);}}};window.hideLoading=function(){if(loader){const fadeOutDuration=500;loader.style.opacity="0";setTimeout(()=>{loader.style.display="none";loader.style.opacity="1";},fadeOutDuration);}};function showGlobalLoader(isLongRunning=false){activeRequests++;window.showLoading(10000);if(isLongRunning){return setTimeout(()=>{if(longRunningRequests.size>0){window.hideLoading();}},LONG_REQUEST_THRESHOLD);}}
function hideGlobalLoader(timeoutId=null){activeRequests--;if(timeoutId){clearTimeout(timeoutId);longRunningRequests.delete(timeoutId);}
if(activeRequests<=0&&longRunningRequests.size===0){activeRequests=0;window.hideLoading();}}
function shouldEnableFeatures(){const currentPath=window.location.pathname.toLowerCase();return config.featureEnabledKeywords.some((keyword)=>currentPath.includes(keyword),);}
const originalFetch=window.fetch;window.fetch=function(...args){const isLongRunning=args[1]&&args[1].headers&&args[1].headers["X-Long-Running"];const timeoutId=showGlobalLoader(isLongRunning);if(isLongRunning){longRunningRequests.add(timeoutId);}
return originalFetch.apply(this,args).finally(()=>{hideGlobalLoader(timeoutId);});};(function(open){XMLHttpRequest.prototype.open=function(...args){let timeoutId;this.addEventListener("loadstart",()=>{const isLongRunning=this.getRequestHeader("X-Long-Running")==="true";timeoutId=showGlobalLoader(isLongRunning);if(isLongRunning){longRunningRequests.add(timeoutId);}});this.addEventListener("loadend",()=>{hideGlobalLoader(timeoutId);});open.apply(this,args);};})(XMLHttpRequest.prototype.open);window.customFetch=async function(url,options={}){const isLongRunning=options.headers&&options.headers["X-Long-Running"]==="true";const timeoutId=showGlobalLoader(isLongRunning);if(isLongRunning){longRunningRequests.add(timeoutId);}
try{const response=await fetch(url,options);return response;}catch(error){hideGlobalLoader(timeoutId);throw error;}finally{hideGlobalLoader(timeoutId);}};function setupLoader(){document.addEventListener("submit",function(event){const form=event.target.closest("form");if(form){event.preventDefault();window.showLoading(Infinity);fetch(form.action,{method:form.method,body:new FormData(form),}).finally(()=>{window.hideLoading();});}},true,);window.addEventListener("beforeunload",function(){window.showLoading(Infinity);});window.showLoading();window.addEventListener("load",function(){window.hideLoading();});}
function setupPageFeatures(){function updateMenu(){const currentUrl=window.location.pathname.toLowerCase();const menu=document.querySelector(".nav-container");if(!menu)return;const items=menu.getElementsByClassName("nav-item");for(let item of items){const keyword=item.dataset.keyword.toLowerCase();item.classList.toggle("active",currentUrl.includes(keyword));}}
function setupPlaylistToggle(){const playlistNav=document.querySelector(".playlist-nav");const playlistsList=document.getElementById("playlists");if(!playlistNav||!playlistsList)return;const icon=playlistNav.querySelector(".playlist-toggle-icon");playlistNav.addEventListener("click",()=>{playlistsList.classList.toggle("hidden");playlistNav.classList.toggle("open");if(icon){icon.classList.toggle("rawcon-sort-up",playlistNav.classList.contains("open"),);icon.classList.toggle("rawcon-sort-down",!playlistNav.classList.contains("open"),);}});}
function displayPlaylists(){const playlistsList=document.getElementById("playlists");if(playlistSummary&&playlistSummary.length>0){playlistsList.innerHTML=playlistSummary.map((playlist)=>`<li class="playlist-item"><a href="/playlist/playlist/${playlist.id}?playlist_name=${encodeURIComponent(playlist.name)}"class="playlist-option"><div class="image-container"><img src="/static/dist/img/default-track.svg"
data-src="${playlist.image_url || "/static/dist/img/default-track.svg"}"
alt="${playlist.name}"
class="playlist-image lazy-load"
loading="lazy"
onclick="handlePlaylistClick()"></div><div class="playlist-info"><span class="playlist-name">${playlist.name}</span></div></a></li>`,).join("");}else{playlistsList.innerHTML="<li>No playlists available</li>";}
lazyLoadImages();}
function lazyLoadImages(){const images=document.querySelectorAll("img.lazy-load");const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach((entry)=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.classList.remove("lazy-load");observer.unobserve(img);}});},{rootMargin:"0px",threshold:0.1},);images.forEach((img)=>imageObserver.observe(img));}
displayPlaylists();updateMenu();setupPlaylistToggle();window.addEventListener("popstate",updateMenu);}
document.addEventListener("DOMContentLoaded",function(){setupLoader();if(shouldEnableFeatures()){setupPageFeatures();}});